# .github/workflows/deploy-preview.yml
name: Deploy Preview to Vercel

on:
  push:
    branches-ignore:
      - main
  workflow_dispatch:

jobs:
  load_env:
    uses: ./.github/workflows/env.yml

  test_scan:
    needs: load_env
    uses: ./.github/workflows/common-test-scan.yml
    permissions:
      security-events: write

  deploy:
    needs: test_scan
    runs-on: ubuntu-latest
    permissions:
      contents: write # to be able to publish a GitHub release
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests
    outputs:
      deploy_url: ${{ steps.vercel_deploy.outputs.deploy_url }}
      deploy_status: ${{ steps.vercel_deploy.outputs.deploy_status }}
    steps:
      # âœ… Step 1 â€” Checkout repo
      # Runs unless checkout action itself fails (rare).
      - uses: actions/checkout@v4

      # âœ… Step 2 â€” Install Vercel CLI
      # â›” If npm install fails (e.g., network or permissions issue),
      #    the remaining steps (sync + deploy) will NOT run.
      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      # âœ… Step 3 â€” Sync Preview Environment
      # Safe: each variable removal/addition uses `|| true`
      # âœ… Even if one fails, the step continues.
      # â›” However, if the entire script exits nonzero for another reason,
      #    the deploy step below will NOT run.
      - name: Sync Preview Environment
        run: |
          echo "Syncing Preview Secrets ..."
          vercel env rm VITE_RECAPTCHA_SITE_KEY preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ secrets.VITE_RECAPTCHA_SITE_KEY }} | vercel env add VITE_RECAPTCHA_SITE_KEY preview --token=${{ secrets.VERCEL_TOKEN }}

          vercel env rm EMAILJS_ACCESSTOKEN preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ secrets.EMAILJS_ACCESSTOKEN }} | vercel env add EMAILJS_ACCESSTOKEN preview --token=${{ secrets.VERCEL_TOKEN }}

          vercel env rm EMAILJS_PUBLICKEY preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ secrets.EMAILJS_PUBLICKEY }} | vercel env add EMAILJS_PUBLICKEY preview --token=${{ secrets.VERCEL_TOKEN }}

          vercel env rm EMAILJS_SERVICE_ID preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ secrets.EMAILJS_SERVICE_ID }} | vercel env add EMAILJS_SERVICE_ID preview --token=${{ secrets.VERCEL_TOKEN }}

          vercel env rm EMAILJS_CU_TEMPLATE_ID preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ secrets.EMAILJS_CU_TEMPLATE_ID }} | vercel env add EMAILJS_CU_TEMPLATE_ID preview --token=${{ secrets.VERCEL_TOKEN }}

          vercel env rm EMAILJS_URL preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ vars.EMAILJS_URL }} | vercel env add EMAILJS_URL preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # ðŸš€ Step 4 â€” Build Release just prior to deploy.
      # â›” If Release Process fails â†’ there will be no deploy.
      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      # ðŸš€ Step 5 â€” Deploy to Vercel (Preview)
      # `set -e` stops execution if *any* line fails.
      # â›” If `vercel deploy` command fails â†’ job exits immediately.
      - name: Deploy to Vercel (Preview)
        id: vercel_deploy
        run: |
          set -e
          DEPLOY_OUTPUT=$(vercel deploy --prebuilt --token="${{ secrets.VERCEL_TOKEN }}" 2>&1)
          echo "$DEPLOY_OUTPUT"
          DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep '^Inspect:' | awk '{print $2}' || true)
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          if [[ -n "$DEPLOY_URL" ]]; then
            echo "deploy_status=success" >> $GITHUB_OUTPUT
          else
            echo "deploy_status=failure" >> $GITHUB_OUTPUT
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

  # ðŸ“¬ Always notify, even if deploy or test_scan fails
  notify:
    if: always() # âœ… ensures this runs regardless of failure
    needs: [load_env, test_scan, deploy]
    uses: ./.github/workflows/common-notify.yml
    with:
      gh_status: ${{ needs.deploy.result }}
      deploy_status: ${{ needs.deploy.outputs.deploy_status }}
      deploy_url: ${{ needs.deploy.outputs.deploy_url }}
    secrets: inherit
