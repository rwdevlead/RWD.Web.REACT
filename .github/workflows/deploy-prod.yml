# .github/workflows/deploy-prod.yml
name: Deploy Production to Vercel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test_scan:
    uses: ./.github/workflows/common-test-scan.yml
    permissions:
      security-events: write

  deploy:
    needs: [test_scan]
    runs-on: ubuntu-latest
    permissions:
      contents: write # to be able to publish a GitHub release
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests
    outputs:
      deploy_url: ${{ steps.vercel_deploy.outputs.deploy_url }}
      deploy_status: ${{ steps.vercel_deploy.outputs.deploy_status }}
    steps:
      # âœ… Step 1 â€” Checkout repo
      # Runs unless checkout action itself fails (rare).
      - uses: actions/checkout@v4

      # âœ… Step 2 â€” Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      # âœ… Step 3 â€” Install Vercel CLI
      # â›” If npm install fails (e.g., network or permissions issue),
      #    the remaining steps (sync + deploy) will NOT run.
      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      # âœ… Step 4 â€” Sync Preview Environment
      # Safe: each variable removal/addition uses `|| true`
      # âœ… Even if one fails, the step continues.
      # â›” However, if the entire script exits nonzero for another reason,
      #    the deploy step below will NOT run.
      - name: Sync Production Environment
        run: |
          echo "Syncing Production Secrets ..."
          vercel env rm VITE_RECAPTCHA_SITE_KEY production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ secrets.VITE_RECAPTCHA_SITE_KEY }} | vercel env add VITE_RECAPTCHA_SITE_KEY production --token=${{ secrets.VERCEL_TOKEN }}

          vercel env rm EMAILJS_ACCESSTOKEN production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ secrets.EMAILJS_ACCESSTOKEN }} | vercel env add EMAILJS_ACCESSTOKEN production --token=${{ secrets.VERCEL_TOKEN }}

          vercel env rm EMAILJS_PUBLICKEY production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ secrets.EMAILJS_PUBLICKEY }} | vercel env add EMAILJS_PUBLICKEY production --token=${{ secrets.VERCEL_TOKEN }}

          vercel env rm EMAILJS_SERVICE_ID production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ secrets.EMAILJS_SERVICE_ID }} | vercel env add EMAILJS_SERVICE_ID production --token=${{ secrets.VERCEL_TOKEN }}

          vercel env rm EMAILJS_CU_TEMPLATE_ID production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ secrets.EMAILJS_CU_TEMPLATE_ID }} | vercel env add EMAILJS_CU_TEMPLATE_ID production --token=${{ secrets.VERCEL_TOKEN }}

          vercel env rm EMAILJS_URL production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
          echo ${{ vars.EMAILJS_URL }} | vercel env add EMAILJS_URL production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # ðŸš€ Step 5 â€” Build Release just prior to deploy.
      # â›” If Release Process fails â†’ there will be no deploy.
      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm install --save-dev \
            semantic-release \
            @semantic-release/git \
            @semantic-release/changelog \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator
          npx semantic-release

      # ðŸš€ Step 6 â€” Deploy to Vercel (Preview)
      # `set -e` stops execution if *any* line fails.
      # â›” If `vercel deploy` command fails â†’ job exits immediately.
      - name: Deploy to Vercel (Production)
        id: vercel_deploy
        run: |
          set -e
          DEPLOY_OUTPUT=$(vercel deploy --prebuilt --prod --token="${{ secrets.VERCEL_TOKEN }}" 2>&1)
          echo "$DEPLOY_OUTPUT"
          DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep '^Inspect:' | awk '{print $2}' || true)
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          if [[ -n "$DEPLOY_URL" ]]; then
            echo "deploy_status=success" >> $GITHUB_OUTPUT
          else
            echo "deploy_status=failure" >> $GITHUB_OUTPUT
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

  # ðŸ“¬ Always notify, even if deploy or test_scan fails
  notify:
    if: always() # âœ… ensures this runs regardless of failure
    needs: [test_scan, deploy]
    uses: ./.github/workflows/common-notify.yml
    with:
      gh_status: ${{ needs.deploy.result }}
      deploy_status: ${{ needs.deploy.outputs.deploy_status }}
      deploy_url: ${{ needs.deploy.outputs.deploy_url }}
    secrets: inherit
