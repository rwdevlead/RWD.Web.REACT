# .github/workflows/common-notify.yml
name: Common - Notify
on:
  workflow_call:
    inputs:
      gh_status:
        required: true
        type: string
      deploy_status:
        required: true
        type: string
      deploy_url:
        required: false
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send notification via EmailJS
        env:
          EMAILJS_SERVICE_ID: ${{ secrets.EMAILJS_SERVICE_ID }}
          EMAILJS_TEMPLATE_ID: ${{ secrets.EMAILJS_AR_TEMPLATE_ID }}
          EMAILJS_PUBLIC_KEY: ${{ secrets.EMAILJS_PUBLICKEY }}
          EMAILJS_ACCESS_TOKEN: ${{ secrets.EMAILJS_ACCESSTOKEN }}
          RWD_EMAIL_TO: ${{ secrets.RWD_EMAIL_TO }}
        run: |
          GH_STATUS="${{ inputs.gh_status }}"
          DEPLOY_STATUS="${{ inputs.deploy_status }}"
          DEPLOY_URL="${{ inputs.deploy_url }}"

          if [ -n "$DEPLOY_URL" ]; then
            LINK_MSG="üåê <a href='$DEPLOY_URL'>View Vercel Deployment</a>"
          else
            LINK_MSG=""
          fi

          GH_LINK_MSG="üêô <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View GitHub Workflow</a>"
          GH_EMOJI=$( [[ "$GH_STATUS" == "success" ]] && echo "‚úÖ" || echo "‚ùå" )
          DEPLOY_EMOJI=$( [[ "$DEPLOY_STATUS" == "success" ]] && echo "‚úÖ" || echo "‚ùå" )

          MESSAGE="<b>GitHub Action:</b> ${{ github.workflow }}<br>\
          <b>Repository:</b> ${{ github.repository }}<br>\
          <b>Branch:</b> ${{ github.ref_name }}<br><br>\
          <b>GitHub Job:</b> $GH_EMOJI <b>$GH_STATUS</b> $GH_LINK_MSG<br>\
          <b>Vercel Deploy:</b> $DEPLOY_EMOJI <b>$DEPLOY_STATUS</b> $LINK_MSG"

          curl -X POST https://api.emailjs.com/api/v1.0/email/send \
            -H 'Content-Type: application/json' \
            -d "{
              \"service_id\": \"$EMAILJS_SERVICE_ID\",
              \"template_id\": \"$EMAILJS_TEMPLATE_ID\",
              \"user_id\": \"$EMAILJS_PUBLIC_KEY\",
              \"accessToken\": \"$EMAILJS_ACCESS_TOKEN\",
              \"template_params\": {
                \"to_email\": \"$RWD_EMAIL_TO\",
                \"subject\": \"üöÄ Vercel Deploy $DEPLOY_STATUS\",
                \"message\": \"$MESSAGE\"
              }
            }"
