name: Test, Scan & Deploy Monorepo to Vercel

on:
  push:
    branches:
      - main
      - feature/** # deploy previews for feature branches
  workflow_dispatch:

jobs:
  vercel_deploy:
    permissions:
      security-events: write
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3Ô∏è‚É£ Install root dependencies
      - name: Install dependencies
        run: npm install

      # 4Ô∏è‚É£ Run backend tests
      - name: Run workspace tests
        run: npm run test
        working-directory: test/backend

      # 5Ô∏è‚É£ Security scans
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

      # 6Ô∏è‚É£ Install Vercel CLI
      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      # 7Ô∏è‚É£ Sync secrets (Prod + Preview)
      - name: Sync environment variables to Vercel
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Syncing Production Secrets ..."
            vercel env rm VITE_RECAPTCHA_SITE_KEY production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ secrets.VITE_RECAPTCHA_SITE_KEY }} | vercel env add VITE_RECAPTCHA_SITE_KEY production --token=${{ secrets.VERCEL_TOKEN }}

            vercel env rm EMAILJS_ACCESSTOKEN production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ secrets.EMAILJS_ACCESSTOKEN }} | vercel env add EMAILJS_ACCESSTOKEN production --token=${{ secrets.VERCEL_TOKEN }}

            vercel env rm EMAILJS_PUBLICKEY production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ secrets.EMAILJS_PUBLICKEY }} | vercel env add EMAILJS_PUBLICKEY production --token=${{ secrets.VERCEL_TOKEN }}

            vercel env rm EMAILJS_SERVICE_ID production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ secrets.EMAILJS_SERVICE_ID }} | vercel env add EMAILJS_SERVICE_ID production --token=${{ secrets.VERCEL_TOKEN }}

            vercel env rm EMAILJS_CU_TEMPLATE_ID production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ secrets.EMAILJS_CU_TEMPLATE_ID }} | vercel env add EMAILJS_CU_TEMPLATE_ID production --token=${{ secrets.VERCEL_TOKEN }}

            vercel env rm EMAILJS_URL production --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ vars.EMAILJS_URL }} | vercel env add EMAILJS_URL production --token=${{ secrets.VERCEL_TOKEN }}
          else
            echo "Syncing Preview Secrets ..."
            vercel env rm VITE_RECAPTCHA_SITE_KEY preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ secrets.VITE_RECAPTCHA_SITE_KEY }} | vercel env add VITE_RECAPTCHA_SITE_KEY preview --token=${{ secrets.VERCEL_TOKEN }}

            vercel env rm EMAILJS_ACCESSTOKEN preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ secrets.EMAILJS_ACCESSTOKEN }} | vercel env add EMAILJS_ACCESSTOKEN preview --token=${{ secrets.VERCEL_TOKEN }}

            vercel env rm EMAILJS_PUBLICKEY preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ secrets.EMAILJS_PUBLICKEY }} | vercel env add EMAILJS_PUBLICKEY preview --token=${{ secrets.VERCEL_TOKEN }}

            vercel env rm EMAILJS_SERVICE_ID preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ secrets.EMAILJS_SERVICE_ID }} | vercel env add EMAILJS_SERVICE_ID preview --token=${{ secrets.VERCEL_TOKEN }}

            vercel env rm EMAILJS_CU_TEMPLATE_ID preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ secrets.EMAILJS_CU_TEMPLATE_ID }} | vercel env add EMAILJS_CU_TEMPLATE_ID preview --token=${{ secrets.VERCEL_TOKEN }}

            vercel env rm EMAILJS_URL preview --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo ${{ vars.EMAILJS_URL }} | vercel env add EMAILJS_URL preview --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # 8Ô∏è‚É£ Deploy step
      - name: Deploy to Vercel
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Deploying to Production..."
            vercel pull --yes --environment=production --token="${{ secrets.VERCEL_TOKEN }}"
            vercel build --prod --token="${{ secrets.VERCEL_TOKEN }}"
            vercel deploy --prebuilt --prod --token="${{ secrets.VERCEL_TOKEN }}"
          else
            echo "Deploying to Preview..."
            vercel pull --yes --environment=preview --token="${{ secrets.VERCEL_TOKEN }}"
            vercel build --token="${{ secrets.VERCEL_TOKEN }}"
            vercel deploy --prebuilt --token="${{ secrets.VERCEL_TOKEN }}"
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send notification via EmailJS
        run: |
          STATUS="${{ needs.deploy.result }}"
          MESSAGE="GitHub Action: ${{ github.workflow }}<br>Repository: ${{ github.repository }}<br>Branch: ${{ github.ref_name }}<br>Status: $STATUS<br><br><a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Details</a>"
          
          curl -X POST https://api.emailjs.com/api/v1.0/email/send \
            -H 'Content-Type: application/json' \
            -d "{
              \"service_id\": \"${{ secrets.EMAILJS_SERVICE_ID }}\",
              \"template_id\": \"${{ secrets.EMAILJS_TEMPLATE_ID }}\",
              \"user_id\": \"${{ secrets.EMAILJS_PUBLIC_KEY }}\",
              \"accessToken\": \"${{ secrets.EMAILJS_PRIVATE_KEY }}\",
              \"template_params\": {
                \"to_email\": \"${{ secrets.EMAIL_TO }}\",
                \"subject\": \"üöÄ Vercel Deploy $STATUS\",
                \"message\": \"$MESSAGE\"
              }
            }"

